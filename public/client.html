// public/client.js
const socket = io();

const elRoom = document.getElementById("room");
const elJoin = document.getElementById("join");
const elCopyRoom = document.getElementById("copyRoom");

const elWord = document.getElementById("word");
const elSend = document.getElementById("send");

const elLog = document.getElementById("log");
const elCurrentWord = document.getElementById("currentWord");
const elTurn = document.getElementById("turn");
const elTimeLeft = document.getElementById("timeLeft");
const elTimerFill = document.getElementById("timerFill");
const elStatusText = document.getElementById("statusText");

let roomCode = "";
let myId = "";
let deadline = 0;
let timeLimitMs = 0;
let timerInterval = null;

function nowTime() {
  return new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

function log(msg) {
  elLog.textContent += `[${nowTime()}] ${msg}\n`;
  elLog.scrollTop = elLog.scrollHeight;
}

function setStatus(text) {
  if (elStatusText) elStatusText.textContent = text;
}

function setTurnLabel(turnId) {
  elTurn.textContent = turnId ? (turnId === myId ? "YOU" : "OPPONENT") : "(waiting)";
}

socket.on("connect", () => {
  myId = socket.id;
  setStatus("Connected");
  log(`âœ… Connected: ${myId}`);
});

socket.on("disconnect", () => {
  setStatus("Disconnected");
  log("âŒ Disconnected.");
  if (timerInterval) clearInterval(timerInterval);
  elTimeLeft.textContent = "-";
  if (elTimerFill) elTimerFill.style.width = "0%";
});

elJoin?.addEventListener("click", () => {
  roomCode = (elRoom.value || "").trim();
  if (!roomCode) {
    log("âŒ Room codeë¥¼ ìž…ë ¥í•´ì¤˜.");
    return;
  }
  socket.emit("join", { roomCode });
});

elCopyRoom?.addEventListener("click", async () => {
  const v = (elRoom.value || "").trim();
  if (!v) return;

  try {
    await navigator.clipboard.writeText(v);
    log(`âœ… Room code copied: ${v}`);
  } catch {
    log("âŒ Copy ì‹¤íŒ¨ (ë¸Œë¼ìš°ì € ê¶Œí•œ ë¬¸ì œ).");
  }
});

elSend?.addEventListener("click", () => {
  const w = (elWord.value || "").trim();
  if (!roomCode) {
    log("âŒ ë¨¼ì € Roomì— Join í•´ì¤˜.");
    return;
  }
  if (!w) return;

  socket.emit("play", { roomCode, word: w });
  elWord.value = "";
  elWord.focus();
});

elWord?.addEventListener("keydown", (e) => {
  if (e.key === "Enter") elSend.click();
});

/* ===== socket events ===== */

socket.on("join_error", ({ message }) => {
  log(`âŒ Join error: ${message}`);
});

socket.on("system", ({ message }) => {
  log(`â€¢ ${message}`);
});

socket.on("state", ({ players, currentWord, turn }) => {
  elCurrentWord.textContent = currentWord || "(none)";
  setTurnLabel(turn);
  log(`Players: ${players.length}/2`);

  // waiting state -> reset timer UI
  if (!turn || players.length < 2) {
    elTimeLeft.textContent = "-";
    if (elTimerFill) elTimerFill.style.width = "0%";
    if (timerInterval) clearInterval(timerInterval);
  }
});

socket.on("timer", ({ deadline: dl, turn, timeLimitMs: tl }) => {
  deadline = dl;
  timeLimitMs = tl;

  setTurnLabel(turn);

  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const leftMs = Math.max(0, deadline - Date.now());
    elTimeLeft.textContent = (leftMs / 1000).toFixed(1) + "s";

    // progress bar: 100% -> 0%
    const pct = timeLimitMs ? (leftMs / timeLimitMs) * 100 : 0;
    if (elTimerFill) elTimerFill.style.width = `${Math.max(0, Math.min(100, pct))}%`;

    if (leftMs <= 0) {
      // stop visually (server will announce result)
      clearInterval(timerInterval);
    }
  }, 80);
});

socket.on("accept", ({ word, nextTurn }) => {
  elCurrentWord.textContent = word;
  setTurnLabel(nextTurn);
  log(`âœ… Accepted: ${word}`);
});

socket.on("reject", (r) => {
  const extra = r.mustStart ? ` (must start with ${r.mustStart})` : "";
  log(`âŒ Rejected: ${r.reason}${extra}`);
});

socket.on("round_end", ({ reason, winner }) => {
  log(`ðŸ Round end (${reason}). Winner: ${winner === myId ? "YOU" : "OPPONENT"}`);
  elCurrentWord.textContent = "(none)";
  elTimeLeft.textContent = "-";
  if (elTimerFill) elTimerFill.style.width = "0%";
});

socket.on("player_left", ({ id }) => {
  log(`â€¢ Player left: ${id}`);
});